name: Deploy Spotify Explorer
on:
    push:
        branches: [main]

jobs:
    deploy:
        runs-on: self-hosted
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Install pnpm
              run: npm install -g pnpm

            - name: Build & Deploy LOCAL
              run: |
                  # BUILD LOCAL en runner
                  pnpm install --frozen-lockfile
                  pnpm build

                  # LIMPIAR servidor
                  rm -rf /var/www/spotify_explorer/*

                  # COPIAR TODO INCLUYENDO .next
                  rsync -avz --delete \
                    --exclude='.git' \
                    --exclude='node_modules' \
                    ./ /var/www/spotify_explorer/

                  # INSTALAR PROD en servidor
                  cd /var/www/spotify_explorer
                  pnpm install --prod --frozen-lockfile

                  # VERIFICAR .next
                  echo "=== CHUNKS VERIFICADOS ==="
                  ls -la /var/www/spotify_explorer/.next/static/chunks/ | head -5

                  pm2 restart spotify_explorer
