name: Deploy Spotify Explorer
on:
    push:
        branches: [main]

jobs:
    deploy:
        runs-on: self-hosted
        environment: workflow-runner

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Install pnpm
              run: npm install -g pnpm

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Approve pnpm build scripts
              run: pnpm approve-builds || true

            - name: Create .env file for build
              run: |
                  cat > .env << EOF
                  SPOTIFY_CLIENT_ID=${{ secrets.SPOTIFY_CLIENT_ID }}
                  SPOTIFY_CLIENT_SECRET=${{ secrets.SPOTIFY_CLIENT_SECRET }}
                  NEXT_PUBLIC_SPOTIFY_CLIENT_ID=${{ secrets.SPOTIFY_CLIENT_ID }}
                  NEXT_PUBLIC_REDIRECT_URI=${{ secrets.NEXT_PUBLIC_REDIRECT_URI }}
                  EOF

            - name: Build application
              run: pnpm build

            - name: Sync to /var/www/spotify_explorer
              run: |
                  rsync -avz --delete \
                    --exclude '.git' \
                    --exclude 'node_modules' \
                    ./ /var/www/spotify_explorer/

            - name: Install production dependencies
              run: |
                  cd /var/www/spotify_explorer
                  pnpm install --frozen-lockfile --prod
                  pnpm add dotenv

            - name: Create production .env file
              run: |
                  cat > /var/www/spotify_explorer/.env << EOF
                  SPOTIFY_CLIENT_ID=${{ secrets.SPOTIFY_CLIENT_ID }}
                  SPOTIFY_CLIENT_SECRET=${{ secrets.SPOTIFY_CLIENT_SECRET }}
                  NEXT_PUBLIC_SPOTIFY_CLIENT_ID=${{ secrets.SPOTIFY_CLIENT_ID }}
                  NEXT_PUBLIC_REDIRECT_URI=${{ secrets.NEXT_PUBLIC_REDIRECT_URI }}
                  NODE_ENV=production
                  PORT=3000
                  EOF

            - name: Deploy with PM2
              run: |
                  cd /var/www/spotify_explorer
                  pm2 delete spotify_explorer 2>/dev/null || true
                  pm2 start ecosystem.config.js --env production
                  pm2 save --force

            - name: Health check
              run: |
                  sleep 5
                  curl -f http://localhost:3000 || echo "Health check failed"
