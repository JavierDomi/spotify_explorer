name: Deploy Spotify Explorer
on:
    push:
        branches: [main]

jobs:
    deploy:
        runs-on: self-hosted
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Install pnpm
              run: npm install -g pnpm

            - name: Build
              run: |
                  pnpm install --frozen-lockfile
                  pnpm build

            - name: Deploy TODO
              run: |
                  rm -rf /var/www/spotify_explorer/*
                  rsync -avz --delete \
                    --exclude='.git' \
                    --exclude='node_modules' \
                    --exclude='.github' \
                    --exclude='*.md' \
                    ./ /var/www/spotify_explorer/

                  cd /var/www/spotify_explorer
                  pnpm install --prod --frozen-lockfile

                  # VERIFICAR archivos est√°ticos
                  echo "=== VERIFICANDO STATIC CHUNKS ==="
                  ls -la .next/static/chunks/ | head -5 || echo "Chunks OK"

                  pm2 restart spotify_explorer || pm2 start ecosystem.config.js --env production
                  pm2 save
